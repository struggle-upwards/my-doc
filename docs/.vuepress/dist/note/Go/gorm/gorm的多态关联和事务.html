<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <title>Gorm学习（五）进阶：多态关联、关联标签以及事务 | 学习文档</title><meta name="description" content="欢迎来到浩瀚星河的小站">
    <link rel="preload" href="/assets/style-B2A49VGO.css" as="style"><link rel="stylesheet" href="/assets/style-B2A49VGO.css">
    <link rel="modulepreload" href="/assets/app-DwZAwhNE.js"><link rel="modulepreload" href="/assets/gorm的多态关联和事务.html-Dle8Sixp.js">
    <link rel="prefetch" href="/assets/index.html-B5bsLUjP.js" as="script"><link rel="prefetch" href="/assets/index.html-CgNoTJhN.js" as="script"><link rel="prefetch" href="/assets/index.html-B92wDFmD.js" as="script"><link rel="prefetch" href="/assets/Django.html-DDacCfo3.js" as="script"><link rel="prefetch" href="/assets/Drf用户认证.html-CS7y7RHR.js" as="script"><link rel="prefetch" href="/assets/index.html-BjtZwkJR.js" as="script"><link rel="prefetch" href="/assets/Token详解.html-DkRUE8mK.js" as="script"><link rel="prefetch" href="/assets/blog-readme.html-B_8dgP-i.js" as="script"><link rel="prefetch" href="/assets/docker-compose命令.html-AD86Rl1D.js" as="script"><link rel="prefetch" href="/assets/docker命令.html-94i0lE-O.js" as="script"><link rel="prefetch" href="/assets/docker部署gin_vue博客.html-8RCDIt-C.js" as="script"><link rel="prefetch" href="/assets/docker部署ollama.html-CKDB_-9P.js" as="script"><link rel="prefetch" href="/assets/index.html-CUILA06E.js" as="script"><link rel="prefetch" href="/assets/git命令.html-DL50XBs3.js" as="script"><link rel="prefetch" href="/assets/index.html-Dzff-NkP.js" as="script"><link rel="prefetch" href="/assets/index.html-DF2mS4O1.js" as="script"><link rel="prefetch" href="/assets/postgresql增删改查.html-BJWqNTLt.js" as="script"><link rel="prefetch" href="/assets/postgresql文档.html-Nuocg8km.js" as="script"><link rel="prefetch" href="/assets/index.html-D8UGRU2q.js" as="script"><link rel="prefetch" href="/assets/创建openguass容器.html-DXeQXBfC.js" as="script"><link rel="prefetch" href="/assets/第一次实验.html-BCjBPOri.js" as="script"><link rel="prefetch" href="/assets/index.html-DqMTpkJl.js" as="script"><link rel="prefetch" href="/assets/uni-app中pages.json的配置.html-xcVrn4zX.js" as="script"><link rel="prefetch" href="/assets/uni-app命令行创建项目.html-MJC_auZ9.js" as="script"><link rel="prefetch" href="/assets/uni-app拦截器.html-sumNCSLB.js" as="script"><link rel="prefetch" href="/assets/uni-app轮播图.html-D3IrD4FA.js" as="script"><link rel="prefetch" href="/assets/vscode中的uniapp配置.html-DUR7KZi0.js" as="script"><link rel="prefetch" href="/assets/index.html-BIcS-Wes.js" as="script"><link rel="prefetch" href="/assets/Linux指令.html-RGc0OBSd.js" as="script"><link rel="prefetch" href="/assets/index.html-CyWkO7xx.js" as="script"><link rel="prefetch" href="/assets/操作系统的定义.html-rPsBFKI8.js" as="script"><link rel="prefetch" href="/assets/进程.html-CawSV8IG.js" as="script"><link rel="prefetch" href="/assets/gorm无法寻址.html-Iy5zwVIK.js" as="script"><link rel="prefetch" href="/assets/gin实现热加载.html-D-0QAgHe.js" as="script"><link rel="prefetch" href="/assets/gin获取路径参数.html-L530o3sC.js" as="script"><link rel="prefetch" href="/assets/gorm一对一.html-Bg_lIls8.js" as="script"><link rel="prefetch" href="/assets/gorm一对多.html-C1crzXow.js" as="script"><link rel="prefetch" href="/assets/gorm增删改查.html-BUw91E77.js" as="script"><link rel="prefetch" href="/assets/gorm多态关联.html-Vwr1exos.js" as="script"><link rel="prefetch" href="/assets/gorm的Many_To_Many.html-BUoQkj4O.js" as="script"><link rel="prefetch" href="/assets/gorm的关联.html-C9WKP16f.js" as="script"><link rel="prefetch" href="/assets/gorm连接mysql.html-BfXJtWOo.js" as="script"><link rel="prefetch" href="/assets/go_get和go_install区别.html-DuJ1Ivx5.js" as="script"><link rel="prefetch" href="/assets/go变量声明.html-BaL58zrw.js" as="script"><link rel="prefetch" href="/assets/go文件操作.html-sTQc17RJ.js" as="script"><link rel="prefetch" href="/assets/go环境变量及配置.html-CUTW7RGA.js" as="script"><link rel="prefetch" href="/assets/go的printf占位符.html-Bq2-Ex9r.js" as="script"><link rel="prefetch" href="/assets/index.html-Bp1wNhMS.js" as="script"><link rel="prefetch" href="/assets/css3中的sticky定位.html-CsUBvJ-H.js" as="script"><link rel="prefetch" href="/assets/css3中的伪类.html-DB-b9zUk.js" as="script"><link rel="prefetch" href="/assets/css3的calc()实现子容器撑满父容器.html-Bw2vtUSg.js" as="script"><link rel="prefetch" href="/assets/element-plus导入自定义主题色.html-fZzcSO8i.js" as="script"><link rel="prefetch" href="/assets/element-plus表单校验.html-gp5FANhY.js" as="script"><link rel="prefetch" href="/assets/elementplus去除菜单下划线.html-CJUGRLau.js" as="script"><link rel="prefetch" href="/assets/无法找到.vue.html-CJ5zVmcT.js" as="script"><link rel="prefetch" href="/assets/sass(scss)的原生配置.html-BXXxb1-1.js" as="script"><link rel="prefetch" href="/assets/sass中的占位选择器.html-DrATi2Rl.js" as="script"><link rel="prefetch" href="/assets/pinia的信息存入LocalStorage.html-l9lhTnaa.js" as="script"><link rel="prefetch" href="/assets/vue3中的pinia的使用.html-Dgjq-XqA.js" as="script"><link rel="prefetch" href="/assets/async和await的使用.html-C60Fzg7u.js" as="script"><link rel="prefetch" href="/assets/es6模板字符串.html-C8KvV4cx.js" as="script"><link rel="prefetch" href="/assets/export和export_default的区别.html-DDz1rnwo.js" as="script"><link rel="prefetch" href="/assets/import的使用.html-B3tTLcHZ.js" as="script"><link rel="prefetch" href="/assets/js函数注释.html-DDfrPUx5.js" as="script"><link rel="prefetch" href="/assets/js的可选链运算符.html-B0PEA6WY.js" as="script"><link rel="prefetch" href="/assets/promise函数的使用.html-D-QF-tgr.js" as="script"><link rel="prefetch" href="/assets/prettier格式化插件.html-C8FXnS2R.js" as="script"><link rel="prefetch" href="/assets/vue3中keep-alive的使用.html-BgESgra8.js" as="script"><link rel="prefetch" href="/assets/vue3中滚动行为scrollBehavior.html-B-IH9cQo.js" as="script"><link rel="prefetch" href="/assets/vue3中的router-view.html-DpRHj3R2.js" as="script"><link rel="prefetch" href="/assets/vue3中配置@别名.html-C27Fd91q.js" as="script"><link rel="prefetch" href="/assets/vue2的sass-loader载入问题.html-CCZGZ2Gf.js" as="script"><link rel="prefetch" href="/assets/vue2自定义登录组件.html-OWPcAgPV.js" as="script"><link rel="prefetch" href="/assets/vue2路由只能跳转一次问题.html-Dl7tr37x.js" as="script"><link rel="prefetch" href="/assets/vue2配置.html-SVqTHw90.js" as="script"><link rel="prefetch" href="/assets/vue3中hooks和pinia的区别.html-Bv79zJKB.js" as="script"><link rel="prefetch" href="/assets/vue3中sass的使用.html-DyKV_prs.js" as="script"><link rel="prefetch" href="/assets/vue3中slot和props的区别.html-Dem20T_9.js" as="script"><link rel="prefetch" href="/assets/vue3中使用defineProps和defineEmits.html-Q146BN89.js" as="script"><link rel="prefetch" href="/assets/vue3中的computed和watch方法.html-BWAF-OW9.js" as="script"><link rel="prefetch" href="/assets/vue3中的npm安装包.html-ck1si-Iy.js" as="script"><link rel="prefetch" href="/assets/vue3中的provide和inject.html-BvAmu7XS.js" as="script"><link rel="prefetch" href="/assets/vue3中的scoped和v-deep.html-C_DkQ2rs.js" as="script"><link rel="prefetch" href="/assets/vue3使用props传值.html-BFBLN6gQ.js" as="script"><link rel="prefetch" href="/assets/vue3使用slot传值.html-C0FISvxd.js" as="script"><link rel="prefetch" href="/assets/vue3配置axios.html-_LXIuueO.js" as="script"><link rel="prefetch" href="/assets/单文件和多文件.html-CUsiRLfA.js" as="script"><link rel="prefetch" href="/assets/响应式和声明式.html-9TAKFtuI.js" as="script"><link rel="prefetch" href="/assets/选项式和组合式.html-C4ghBHiF.js" as="script"><link rel="prefetch" href="/assets/图片放大镜效果.html-CnTX5Xka.js" as="script"><link rel="prefetch" href="/assets/useIntersectionObserver.html-a941Wtp9.js" as="script"><link rel="prefetch" href="/assets/useScroll.html-DJsH4Vgv.js" as="script"><link rel="prefetch" href="/assets/404.html-C7UdPfas.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container external-link-icon"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="site-name" aria-hidden="true">学习文档</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link auto-link" href="/introduction/" aria-label="简介"><!---->简介<!----></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link auto-link" href="/introduction/" aria-label="简介"><!---->简介<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link sidebar-item sidebar-heading" href="/note/" aria-label="返回上一级目录"><!---->返回上一级目录<!----></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">Go <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link auto-link sidebar-item" href="/note/Go/%E5%A5%87%E6%B7%BC/" aria-label="奇淼"><!---->奇淼<!----></a><!----></li><li><p tabindex="0" class="sidebar-item collapsible">bug <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a class="route-link auto-link sidebar-item" href="/note/Go/bug/gorm%E6%97%A0%E6%B3%95%E5%AF%BB%E5%9D%80.html" aria-label="gorm无法寻址"><!---->gorm无法寻址<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">Gin <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a class="route-link auto-link sidebar-item" href="/note/Go/Gin/gin%E8%8E%B7%E5%8F%96%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0.html" aria-label="gin获取路径参数"><!---->gin获取路径参数<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/Gin/gin%E5%AE%9E%E7%8E%B0%E7%83%AD%E5%8A%A0%E8%BD%BD.html" aria-label="gin实现热加载"><!---->gin实现热加载<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item collapsible">go基础知识 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a class="route-link auto-link sidebar-item" href="/note/Go/go基础知识/go get 和go install区别.html" aria-label="go get 和go install区别"><!---->go get 和go install区别<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/go%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/go%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E.html" aria-label="go变量声明"><!---->go变量声明<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/go%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/go%E7%9A%84printf%E5%8D%A0%E4%BD%8D%E7%AC%A6.html" aria-label="go的printf占位符"><!---->go的printf占位符<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/go%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/go%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%8F%8A%E9%85%8D%E7%BD%AE.html" aria-label="go环境变量及配置"><!---->go环境变量及配置<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/go%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/go%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C.html" aria-label="go文件操作"><!---->go文件操作<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item active collapsible">gorm <span class="down arrow"></span></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link auto-link sidebar-item active" href="/note/Go/gorm/gorm%E7%9A%84%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94%E5%92%8C%E4%BA%8B%E5%8A%A1.html" aria-label="gorm的多态关联和事务"><!---->gorm的多态关联和事务<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm%E7%9A%84%E5%85%B3%E8%81%94.html" aria-label="gorm的关联"><!---->gorm的关联<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm的Many To Many.html" aria-label="gorm的Many To Many"><!---->gorm的Many To Many<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94.html" aria-label="gorm多态关联"><!---->gorm多态关联<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm%E8%BF%9E%E6%8E%A5mysql.html" aria-label="gorm连接mysql"><!---->gorm连接mysql<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm%E4%B8%80%E5%AF%B9%E5%A4%9A.html" aria-label="gorm一对多"><!---->gorm一对多<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm%E4%B8%80%E5%AF%B9%E4%B8%80.html" aria-label="gorm一对一"><!---->gorm一对一<!----></a><!----></li><li><a class="route-link auto-link sidebar-item" href="/note/Go/gorm/gorm%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html" aria-label="gorm增删改查"><!---->gorm增删改查<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="gorm学习-五-进阶-多态关联、关联标签以及事务" tabindex="-1"><a class="header-anchor" href="#gorm学习-五-进阶-多态关联、关联标签以及事务"><span>Gorm学习（五）进阶：多态关联、关联标签以及事务</span></a></h1><h4 id="目录" tabindex="-1"><a class="header-anchor" href="#目录"><span>目录</span></a></h4><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><blockquote><p>感谢开源项目，以及 本人学识尚浅，如有错误，请评论指出，谢谢！ 详细可见个人博客：</p></blockquote><h2 id="一、多态关联" tabindex="-1"><a class="header-anchor" href="#一、多态关联"><span>一、多态关联</span></a></h2><h3 id="_1、多态关联概述" tabindex="-1"><a class="header-anchor" href="#_1、多态关联概述"><span>1、多态关联概述</span></a></h3><p>什么是多态？</p><p>多态的概念：通俗来说，就是多种形态，具体点就是去完成某个行为，当不同的对象去完成时会产生出不同的状态。</p><p>什么是多态表？ 假设我们有一张地址表，其中的地址可能是来自User中的，也可能是来自Orders中的。而区分不同的对象则用type字段。如：type=User时对象是文章表。</p><img src="/assets/c9e6b9ae62cc46ec98e16cc1b551a15f-1716901678047-1-npJUZE4i.png" alt="在这里插入图片描述"><h3 id="_2、为什么用多态关联" tabindex="-1"><a class="header-anchor" href="#_2、为什么用多态关联"><span>2、为什么用多态关联？</span></a></h3><p>出现需要外键引用多个表的情况，不可能删除原来表结构，重新添加一个外键ID再建表，所以我们可以建立一个交叉表。让Addres不再依赖于User表或者Order表。 <img src="/assets/a35bad81e6f04d9ababfc8967d32e78a-1716901678047-3-B53fZcS5.png" alt="在这里插入图片描述"> <code>has one</code>的情况解决方案，如果我们希望一个给定的地址，只能够在一张交叉表中出现一次，上面的复合主键已经做到了。</p><p><code>has many</code>的情况解决方案,如果希望一个地址可以在一张交叉表中出现多次，可以取消Address的复合主键。</p><h3 id="_3、has-one" tabindex="-1"><a class="header-anchor" href="#_3、has-one"><span>3、Has One</span></a></h3><p>GORM 为 <code>has one</code> 和 <code>has many</code> 提供了多态关联支持，它会将拥有者实体的表名、主键值都保存到多态类型的字段中。</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID      <span class="token builtin">int</span></span>
<span class="line">	Name    <span class="token builtin">string</span></span>
<span class="line">	<span class="token comment">//polymorphic指定多态类型，比如模型名</span></span>
<span class="line">	Address Address <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID      <span class="token builtin">int</span></span>
<span class="line">	Name    <span class="token builtin">string</span></span>
<span class="line">	Address Address <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID        <span class="token builtin">int</span></span>
<span class="line">	Name      <span class="token builtin">string</span></span>
<span class="line">	OwnerID   <span class="token builtin">int</span></span>
<span class="line">	OwnerType <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Order<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/42109d8b5dc4428584c4aee5a60cd638-1716901678048-5-WtojuynA.png" alt="在这里插入图片描述"><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line">db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">	Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	Address<span class="token punctuation">:</span> Address<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span> <span class="token string">&quot;翻斗花园&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>Order<span class="token punctuation">{</span></span>
<span class="line">	Name<span class="token punctuation">:</span> <span class="token string">&quot;忘崽牛奶&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	Address<span class="token punctuation">:</span> Address<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span> <span class="token string">&quot;火星幼儿园&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img-blog.csdnimg.cn/f21222a9265c4f6b83dec8289e8903bc.png" alt="在这里插入图片描述"> <img src="/assets/3fd7287122ea4dcd97881b1dfd5a34ef-1716901678048-9-BZf-rJv6.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/a0de07b93151442aa8d6c3013178c0a6.png" alt="在这里插入图片描述"></p><blockquote><p>owner_type就是关联的那张表。 owner_id就是关联的表的主键。</p></blockquote><h3 id="_4、has-many" tabindex="-1"><a class="header-anchor" href="#_4、has-many"><span>4、Has Many</span></a></h3><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID      <span class="token builtin">int</span></span>
<span class="line">	Name    <span class="token builtin">string</span></span>
<span class="line">	Address <span class="token punctuation">[</span><span class="token punctuation">]</span>Address <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID      <span class="token builtin">int</span></span>
<span class="line">	Name    <span class="token builtin">string</span></span>
<span class="line">	Address Address <span class="token string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID        <span class="token builtin">int</span></span>
<span class="line">	Name      <span class="token builtin">string</span></span>
<span class="line">	OwnerID   <span class="token builtin">int</span></span>
<span class="line">	OwnerType <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Order<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Address<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Address<span class="token punctuation">{</span></span>
<span class="line">			<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;翻斗花园&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;杭州西湖&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/46c14c4ee4984760b1dc262ffe963741-1716901678048-13-BeStmkvL.png" alt="在这里插入图片描述"><h2 id="二、关联标签" tabindex="-1"><a class="header-anchor" href="#二、关联标签"><span>二、关联标签</span></a></h2><h3 id="_1、polymorphic-polymorphicvalue" tabindex="-1"><a class="header-anchor" href="#_1、polymorphic-polymorphicvalue"><span>1、polymorphic polymorphicValue</span></a></h3><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID   <span class="token builtin">int</span></span>
<span class="line">	Name <span class="token builtin">string</span></span>
<span class="line">	<span class="token comment">//polymorphic：通俗讲用来指定id与type的前缀</span></span>
<span class="line">	Address <span class="token punctuation">[</span><span class="token punctuation">]</span>Address <span class="token string">`gorm:&quot;polymorphic:Address;&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Order <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID      <span class="token builtin">int</span></span>
<span class="line">	Name    <span class="token builtin">string</span></span>
<span class="line">	<span class="token comment">//polymorphicValue用来告诉关联表我是谁，默认都是表名</span></span>
<span class="line">	Address Address <span class="token string">`gorm:&quot;polymorphic:Address;polymorphicValue:master&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID          <span class="token builtin">int</span></span>
<span class="line">	Name        <span class="token builtin">string</span></span>
<span class="line">	AddressID   <span class="token builtin">int</span></span>
<span class="line">	AddressType <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Order<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Address<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Address<span class="token punctuation">{</span></span>
<span class="line">			<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;翻斗花园&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;杭州西湖&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>Order<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span> <span class="token string">&quot;忘崽牛奶&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Address<span class="token punctuation">:</span> Address<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span> <span class="token string">&quot;火星幼儿园&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img-blog.csdnimg.cn/af6eda1f702a4e7690d4d11d51c5dc16.png" alt="在这里插入图片描述"> <img src="/assets/891530b81c494625acbbd03e971e7547-1716901678048-17-BxJLCVQG.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/32b6465508944d2fa659aa2d41710355.png" alt="在这里插入图片描述"></p><h3 id="_2、foreignkey-references" tabindex="-1"><a class="header-anchor" href="#_2、foreignkey-references"><span>2、foreignKey references</span></a></h3><p>GORM里默认是连接表和引用表的主键来作为做外键以及外键映射的。</p><p>Has One的例子：</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	gorm<span class="token punctuation">.</span>Model</span>
<span class="line">	Number <span class="token builtin">string</span></span>
<span class="line">	<span class="token comment">//外键指向CreditCardNumber</span></span>
<span class="line">	Info   Info <span class="token string">`gorm:&quot;foreignKey:CreditCardNumber&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Info <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID               <span class="token builtin">uint</span></span>
<span class="line">	Name             <span class="token builtin">string</span></span>
<span class="line">	Age              <span class="token builtin">int</span></span>
<span class="line">	CreditCardNumber <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Info<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Info<span class="token punctuation">:</span> Info<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;456789&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Info<span class="token punctuation">:</span> Info<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Age<span class="token punctuation">:</span>  <span class="token number">66</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/b52045e09e974dec82e074ce4dd4cd12-1716901678048-21-BZblICSY.png" alt="在这里插入图片描述"><img src="/assets/501eea72d7624710bf8efba4c6f5bcd2-1716901678048-23-D5criL9Q.png" alt="在这里插入图片描述"><blockquote><p>注意：credit_card_number并没有自动指向creditcard表里的number字段，他还是会默认指向引用表里的主键，所以在用<code>foreignKey</code>的时候最好类型相同或者使用<code>references</code>搭配使用。</p></blockquote><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID <span class="token builtin">uint</span></span>
<span class="line">	<span class="token comment">//设置唯一和固定长度</span></span>
<span class="line">	Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:unique;size:255&quot;`</span></span>
<span class="line">	Info   Info   <span class="token string">`gorm:&quot;foreignKey:CreditCardNumber;references:Number&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Info <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID   <span class="token builtin">uint</span></span>
<span class="line">	Name <span class="token builtin">string</span></span>
<span class="line">	Age  <span class="token builtin">int</span></span>
<span class="line">	<span class="token comment">//设置唯一和固定长度</span></span>
<span class="line">	CreditCardNumber <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:unique;size:255&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Info<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		ID<span class="token punctuation">:</span>     <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Info<span class="token punctuation">:</span> Info<span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">			Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		ID<span class="token punctuation">:</span>     <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;456789&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Info<span class="token punctuation">:</span> Info<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Age<span class="token punctuation">:</span>  <span class="token number">66</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意： 某些数据库只允许在唯一索引字段上创建外键，如果在迁移时会创建外键，则需要指定 <code>index:unique</code> 标签。</p></blockquote><p><img src="/assets/9edc60ed7d5e492b95f8649d7a24f4d3-1716901678048-25-FwJ7GYPa.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/345e5edd73b24541999b82aa34a6c167.png" alt="在这里插入图片描述"></p><blockquote><p>错误： <code>Error 1170: BLOB/TEXT column &#39;credit_card_number&#39; used in key specification without a key length</code> 出现这个问题是因为你的外键或者外键映射的字段是text类型也就是不固定长度string类型，不能作为外键或外键映射，必须通过标签<code>size</code>设置固定长度。<code>Error 1215: Cannot add foreign key constraint</code> 这个错误是不能创建外键，主要原因可能是你外键映射的字段不是引用表的主键，建议标签设置为唯一 <code>index:unique</code>。</p></blockquote><h3 id="_3、many-to-many" tabindex="-1"><a class="header-anchor" href="#_3、many-to-many"><span>3、Many to Many</span></a></h3><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID     <span class="token builtin">uint</span></span>
<span class="line">	Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:unique;size:255&quot;`</span></span>
<span class="line">	Infos  <span class="token punctuation">[</span><span class="token punctuation">]</span>Info <span class="token string">`gorm:&quot;many2many:card_infos;foreignKey:Number;references:Name;&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Info <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID   <span class="token builtin">uint</span></span>
<span class="line">	Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:unique;size:255&quot;`</span></span>
<span class="line">	Age  <span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Info<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Infos<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Info<span class="token punctuation">{</span></span>
<span class="line">			<span class="token punctuation">{</span></span>
<span class="line">				ID<span class="token punctuation">:</span>   <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">				Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">				Age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;456789&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Infos<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Info<span class="token punctuation">{</span></span>
<span class="line">			<span class="token punctuation">{</span></span>
<span class="line">				ID<span class="token punctuation">:</span>   <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">				Name<span class="token punctuation">:</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">				Age<span class="token punctuation">:</span>  <span class="token number">66</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">{</span></span>
<span class="line">				ID<span class="token punctuation">:</span>   <span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">				Name<span class="token punctuation">:</span> <span class="token string">&quot;qhgwueiq&quot;</span><span class="token punctuation">,</span></span>
<span class="line">				Age<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img-blog.csdnimg.cn/d5b965e97917407f88bb51376b7d6918.png" alt="在这里插入图片描述"> <img src="/assets/f9c47da108ee46b0bca3f92e00539486-1716901678048-31-BnjmsiMr.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/5e2333aff2044aa6a7a791d0b7fef6f1.png" alt="在这里插入图片描述"></p><blockquote><p>注意：在<code>Many to Many</code>的情况下，foreignKey指向的是<code>引用表的外键映射字段</code>，references指向的是<code>关联表的外键字段</code>，一定不要搞混了。</p></blockquote><h3 id="_4、joinforeignkey-joinreferences" tabindex="-1"><a class="header-anchor" href="#_4、joinforeignkey-joinreferences"><span>4、joinForeignKey joinReferences</span></a></h3><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID     <span class="token builtin">uint</span></span>
<span class="line">	Number <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:unique;size:255&quot;`</span></span>
<span class="line">	Infos  <span class="token punctuation">[</span><span class="token punctuation">]</span>Info <span class="token string">`gorm:&quot;many2many:card_infos;foreignKey:Number;joinForeignKey:card_number;references:Name;joinReferences:name&quot;`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Info <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID   <span class="token builtin">uint</span></span>
<span class="line">	Name <span class="token builtin">string</span> <span class="token string">`gorm:&quot;index:unique;size:255&quot;`</span></span>
<span class="line">	Age  <span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Info<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Infos<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Info<span class="token punctuation">{</span></span>
<span class="line">			<span class="token punctuation">{</span></span>
<span class="line">				ID<span class="token punctuation">:</span>   <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">				Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">				Age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>CreditCard<span class="token punctuation">{</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token string">&quot;456789&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Infos<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Info<span class="token punctuation">{</span></span>
<span class="line">			<span class="token punctuation">{</span></span>
<span class="line">				ID<span class="token punctuation">:</span>   <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">				Name<span class="token punctuation">:</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">				Age<span class="token punctuation">:</span>  <span class="token number">66</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">{</span></span>
<span class="line">				ID<span class="token punctuation">:</span>   <span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">				Name<span class="token punctuation">:</span> <span class="token string">&quot;qhgwueiq&quot;</span><span class="token punctuation">,</span></span>
<span class="line">				Age<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/4f2821bed156416d8d56fe884fec9758-1716901678048-35-Depe7KPm.png" alt="在这里插入图片描述"><h2 id="三、事务" tabindex="-1"><a class="header-anchor" href="#三、事务"><span>三、事务</span></a></h2><h3 id="_1、事务概述" tabindex="-1"><a class="header-anchor" href="#_1、事务概述"><span>1、事务概述</span></a></h3><p>数据库事务( transaction)是访问并可能操作各种数据项的一个<code>数据库操作序列</code>，这些操作要么全部执行，要么全部不执行，是一个不可分割的工作单位。 事务由事务开始与事务结束之间执行的全部数据库操作组成。</p><p>数据库事务必须具备的四个特性：</p><h3 id="_2、事务操作" tabindex="-1"><a class="header-anchor" href="#_2、事务操作"><span>2、事务操作</span></a></h3><p>要在事务中执行一系列操作，一般流程如下：</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	gorm<span class="token punctuation">.</span>Model</span>
<span class="line">	Name <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// 在事务中执行一些 db 操作（从这里开始，应该使用 &#39;tx&#39; 而不是 &#39;db&#39;）</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Giraffe&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// 返回任何错误都会回滚事务</span></span>
<span class="line">			<span class="token keyword">return</span> err</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Lion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> err</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// 返回 nil 提交事务</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/9c0bdf35a2794bcbb88ef85c9ab5e154-1716901678049-37-B6y520UW.png" alt="在这里插入图片描述"><h4 id="_1-回滚" tabindex="-1"><a class="header-anchor" href="#_1-回滚"><span>1）回滚</span></a></h4><blockquote><p>注意：返回任何错误都会回滚事务。回滚则事务内的操作一律不执行。</p></blockquote><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// 在事务中执行一些 db 操作（从这里开始，应该使用 &#39;tx&#39; 而不是 &#39;db&#39;）</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// 返回任何错误都会回滚事务</span></span>
<span class="line">			<span class="token keyword">return</span> err</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> err</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token keyword">if</span> <span class="token boolean">true</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;回滚&quot;</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// 返回 nil 提交事务</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/c28e84c61dbf44b19d19864f5859e234-1716901678049-39-M6_x3rcS.png" alt="在这里插入图片描述"><h4 id="_2-嵌套事务" tabindex="-1"><a class="header-anchor" href="#_2-嵌套事务"><span>2）嵌套事务</span></a></h4><p>嵌套事务的作用在于较大的事务中，你只想回滚一部分操作，例如你去银行转账，已经通过银行卡号和密码登录了，转账的过程是你的银行账户扣去多少钱，同时别人的银行账户加上多少钱，如果中途发生错误，需要回滚，应该回滚到你账号登录后的状态，而不是直接回滚到你账号登录前。</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"></span>
<span class="line"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	gorm<span class="token punctuation">.</span>Model</span>
<span class="line">	Name   <span class="token builtin">string</span></span>
<span class="line">	Number <span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">		tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span>   <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Number<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span>   <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Number<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;登陆后&quot;</span><span class="token punctuation">)</span></span>
<span class="line">		tx<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx2 <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// 在事务中执行一些 db 操作（从这里开始，应该使用 &#39;tx&#39; 而不是 &#39;db&#39;)</span></span>
<span class="line">			<span class="token keyword">if</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token comment">// 返回任何错误都会回滚事务</span></span>
<span class="line">				<span class="token keyword">return</span> err</span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">			<span class="token keyword">if</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token keyword">return</span> err</span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;转账结束&quot;</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token comment">// 返回 nil 提交事务</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/23b30a9f0f254197a524c8bb5d788998-1716901678049-43-BJV_wjc8.png" alt="在这里插入图片描述"><p><img src="/assets/9a49f4a4baaf4b41a3f5e61c980b8824-1716901678049-41-Cl-yyglz.png" alt="在这里插入图片描述"> 正常的过程应该是这样，如果说嵌套事务发生回滚操作之后的情况呢？</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">		tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span>   <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Number<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">			Name<span class="token punctuation">:</span>   <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			Number<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;登陆后&quot;</span><span class="token punctuation">)</span></span>
<span class="line">		tx<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx2 <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// 在事务中执行一些 db 操作（从这里开始，应该使用 &#39;tx&#39; 而不是 &#39;db&#39;)</span></span>
<span class="line">			<span class="token keyword">if</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token comment">// 返回任何错误都会回滚事务</span></span>
<span class="line">				<span class="token keyword">return</span> err</span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">			<span class="token keyword">if</span> <span class="token boolean">true</span> <span class="token punctuation">{</span></span>
<span class="line">				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;转账失败，对面是骗子不能转！！&quot;</span><span class="token punctuation">)</span></span>
<span class="line">				<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;转账失败&quot;</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">			<span class="token keyword">if</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token keyword">return</span> err</span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;转账结束&quot;</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token comment">// 返回 nil 提交事务</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/bbcfbc6e5c3540a0ae554a9e0347fa3a-1716901678049-45-C0xq-9rk.png" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/a403cb86338044609bb79bfa7c708f8f.png" alt="在这里插入图片描述"></p><h3 id="_3、手动事务" tabindex="-1"><a class="header-anchor" href="#_3、手动事务"><span>3、手动事务</span></a></h3><p>Gorm 支持直接调用事务控制方法（commit、rollback），例如：</p><table><thead><tr><th>事务方法</th><th>说明</th></tr></thead><tbody><tr><td>tx := db.Begin()</td><td>开始事务</td></tr><tr><td>tx.（db操作）</td><td>在事务中执行一些 db 操作</td></tr><tr><td>tx.Rollback()</td><td>遇到错误时回滚事务</td></tr><tr><td>tx.SavePoint()</td><td>设置保存点标记</td></tr><tr><td>tx.RollbackTo()</td><td>回滚到保存点标记</td></tr><tr><td>tx.Commit()</td><td>提交事务</td></tr></tbody></table><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	gorm<span class="token punctuation">.</span>Model</span>
<span class="line">	Name   <span class="token builtin">string</span></span>
<span class="line">	Number <span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token comment">// 开始事务</span></span>
<span class="line">	tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 &#39;tx&#39; 而不是 &#39;db&#39;）</span></span>
<span class="line">	tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span>   <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span></span>
<span class="line">		Name<span class="token punctuation">:</span>   <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		Number<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;登陆后&quot;</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token comment">//设置回滚标记</span></span>
<span class="line">	tx<span class="token punctuation">.</span><span class="token function">SavePoint</span><span class="token punctuation">(</span><span class="token string">&quot;登录了&quot;</span><span class="token punctuation">)</span></span>
<span class="line">	flag <span class="token operator">:=</span> <span class="token boolean">true</span></span>
<span class="line">	<span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;linzy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			flag <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;slyyy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			flag <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">//出现问题了得写在一系列事务之后进行回滚</span></span>
<span class="line">		<span class="token keyword">if</span> flag <span class="token punctuation">{</span></span>
<span class="line">			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;转账失败，对面是骗子不能转！！&quot;</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token comment">//回滚到指定标记</span></span>
<span class="line">			tx<span class="token punctuation">.</span><span class="token function">RollbackTo</span><span class="token punctuation">(</span><span class="token string">&quot;登录了&quot;</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// 遇到错误时回滚事务</span></span>
<span class="line">	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;转账结束&quot;</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token comment">// 否则，提交事务</span></span>
<span class="line">	tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/assets/5cf8bdf745d9477daebb4585335b4526-1716901678049-49-wUESncP0.png" alt="在这里插入图片描述"><h4 id="官方示例" tabindex="-1"><a class="header-anchor" href="#官方示例"><span>官方示例：</span></a></h4><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token keyword">func</span> <span class="token function">CreateAnimals</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 再唠叨一下，事务一旦开始，你就应该使用 tx 处理数据</span></span>
<span class="line">  tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment">//延迟函数一定要写上，因为出现panic错误时事务可能没办法回滚，需要手动再回滚</span></span>
<span class="line">  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">      tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Giraffe&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">     <span class="token keyword">return</span> err</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Lion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">     <span class="token keyword">return</span> err</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4、禁用默认事务" tabindex="-1"><a class="header-anchor" href="#_4、禁用默认事务"><span>4、禁用默认事务</span></a></h3><p>为了确保数据一致性，GORM 会在事务里执行写入操作（创建、更新、删除）。如果没有这方面的要求，您可以在初始化时禁用它，这将获得大约 30%+ 性能提升。</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="line"><span class="token comment">// 全局禁用</span></span>
<span class="line">db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span></span>
<span class="line">  SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 持续会话模式</span></span>
<span class="line">tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span>Session<span class="token punctuation">{</span>SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span></span>
<span class="line">tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="四、小结" tabindex="-1"><a class="header-anchor" href="#四、小结"><span>四、小结</span></a></h2><p>本章拓展了GORM对数据库的更多支持，关联标签与事务是很重要的内容。</p><table><thead><tr><th style="text-align:left;">标签</th><th>描述</th></tr></thead><tbody><tr><td style="text-align:left;">foreignKey</td><td>指定当前模型的列作为连接表的外键</td></tr><tr><td style="text-align:left;">references</td><td>指定引用表的列名，其将被映射为连接表外键</td></tr><tr><td style="text-align:left;">polymorphic</td><td>指定多态类型，比如模型名</td></tr><tr><td style="text-align:left;">polymorphicValue</td><td>指定多态值、默认表名</td></tr><tr><td style="text-align:left;">many2many</td><td>指定连接表表名</td></tr><tr><td style="text-align:left;">joinForeignKey</td><td>指定连接表的外键列名，其将被映射到当前表</td></tr><tr><td style="text-align:left;">joinReferences</td><td>指定连接表的外键列名，其将被映射到引用表</td></tr></tbody></table><p>手动事务适用于小事务操作，出错了直接全部回滚会更好，虽然提供了 <code>SavePoint</code>、<code>Rollbackto</code>方法，来提供保存点以及回滚至保存点功能，但是有一些同步操作操作很不方便。 GORM自带事务适用大事务操作，可以使用嵌套事务。</p><blockquote><p>若有写的错误的或者需要改进的地方，希望能直接指出，再次感谢GVA淼哥的教程！</p></blockquote></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 20222131019@m.scnu.edu.cn">struggle-upwards</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DwZAwhNE.js" defer></script>
  </body>
</html>
