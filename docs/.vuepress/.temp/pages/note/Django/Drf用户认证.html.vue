<template><div><p>[TOC]</p>
<h3 id="drf-用户认证-authentication" tabindex="-1"><a class="header-anchor" href="#drf-用户认证-authentication"><span>Drf 用户认证     Authentication</span></a></h3>
<h4 id="as-view的本质" tabindex="-1"><a class="header-anchor" href="#as-view的本质"><span>as_view的本质</span></a></h4>
<p>当用户访问网址时，就会触发视图函数，as_view函数就被触发，在as_view当中，同时调用了他父类的as_view函数。</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token decorator annotation punctuation">@classmethod</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">as_view</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">**</span>initkwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Store the original class on the view function.</span>
<span class="line"></span>
<span class="line">    This allows us to discover information about the view when we do URL</span>
<span class="line">    reverse lookups.  Used for breadcrumb generation.</span>
<span class="line">    """</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token string">'queryset'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span> models<span class="token punctuation">.</span>query<span class="token punctuation">.</span>QuerySet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">def</span> <span class="token function">force_evaluation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span></span>
<span class="line">                <span class="token string">'Do not evaluate the `.queryset` attribute directly, '</span></span>
<span class="line">                <span class="token string">'as the result will be cached and reused between requests. '</span></span>
<span class="line">                <span class="token string">'Use `.all()` or call `.get_queryset()` instead.'</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        cls<span class="token punctuation">.</span>queryset<span class="token punctuation">.</span>_fetch_all <span class="token operator">=</span> force_evaluation</span>
<span class="line"></span>
<span class="line">    view <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token operator">**</span>initkwargs<span class="token punctuation">)</span></span>
<span class="line">    view<span class="token punctuation">.</span>cls <span class="token operator">=</span> cls</span>
<span class="line">    view<span class="token punctuation">.</span>initkwargs <span class="token operator">=</span> initkwargs</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Note: session based authentication is explicitly CSRF validated,</span></span>
<span class="line">    <span class="token comment"># all other authentication is CSRF exempt.</span></span>
<span class="line">    <span class="token keyword">return</span> csrf_exempt<span class="token punctuation">(</span>view<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>父类函数的as_view</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token decorator annotation punctuation">@classonlymethod</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">as_view</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">**</span>initkwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""Main entry point for a request-response process."""</span></span>
<span class="line">    <span class="token keyword">for</span> key <span class="token keyword">in</span> initkwargs<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> key <span class="token keyword">in</span> cls<span class="token punctuation">.</span>http_method_names<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span></span>
<span class="line">                <span class="token string">"The method name %s is not accepted as a keyword argument "</span></span>
<span class="line">                <span class="token string">"to %s()."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> cls<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span></span>
<span class="line">                <span class="token string">"%s() received an invalid keyword %r. as_view "</span></span>
<span class="line">                <span class="token string">"only accepts arguments that are already "</span></span>
<span class="line">                <span class="token string">"attributes of the class."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>initkwargs<span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"request"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span></span>
<span class="line">                <span class="token string">"%s instance has no 'request' attribute. Did you override "</span></span>
<span class="line">                <span class="token string">"setup() and forget to call super()?"</span> <span class="token operator">%</span> cls<span class="token punctuation">.</span>__name__</span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>dispatch<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    view<span class="token punctuation">.</span>view_class <span class="token operator">=</span> cls</span>
<span class="line">    view<span class="token punctuation">.</span>view_initkwargs <span class="token operator">=</span> initkwargs</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># __name__ and __qualname__ are intentionally left unchanged as</span></span>
<span class="line">    <span class="token comment"># view_class should be used to robustly determine the name of the view</span></span>
<span class="line">    <span class="token comment"># instead.</span></span>
<span class="line">    view<span class="token punctuation">.</span>__doc__ <span class="token operator">=</span> cls<span class="token punctuation">.</span>__doc__</span>
<span class="line">    view<span class="token punctuation">.</span>__module__ <span class="token operator">=</span> cls<span class="token punctuation">.</span>__module__</span>
<span class="line">    view<span class="token punctuation">.</span>__annotations__ <span class="token operator">=</span> cls<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>__annotations__</span>
<span class="line">    <span class="token comment"># Copy possible attributes set by decorators, e.g. @csrf_exempt, from</span></span>
<span class="line">    <span class="token comment"># the dispatch method.</span></span>
<span class="line">    view<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>update<span class="token punctuation">(</span>cls<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Mark the callback if the view class is async.</span></span>
<span class="line">    <span class="token keyword">if</span> cls<span class="token punctuation">.</span>view_is_async<span class="token punctuation">:</span></span>
<span class="line">        markcoroutinefunction<span class="token punctuation">(</span>view<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> view</span>
<span class="line"></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其父类的as_view函数的作用就是检验as_view中传递参数的合法性，并且返回一个view，实际上view中实现dispatch方法，再去父类中查找这个dispatch方法，发现父类中并没用找到这个方法。</p>
<p>那我们再去子类中查找这个dispatch方法，如下</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    `.dispatch()` is pretty much the same as Django's regular dispatch,</span>
<span class="line">    but with extra hooks for startup, finalize, and exception handling.</span>
<span class="line">    """</span></span>
<span class="line">    self<span class="token punctuation">.</span>args <span class="token operator">=</span> args</span>
<span class="line">    self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs</span>
<span class="line">    request <span class="token operator">=</span> self<span class="token punctuation">.</span>initialize_request<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">    self<span class="token punctuation">.</span>request <span class="token operator">=</span> request</span>
<span class="line">    self<span class="token punctuation">.</span>headers <span class="token operator">=</span> self<span class="token punctuation">.</span>default_response_headers  <span class="token comment"># deprecate?</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>initial<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># Get the appropriate handler method</span></span>
<span class="line">        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>http_method_names<span class="token punctuation">:</span></span>
<span class="line">            handler <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                                self<span class="token punctuation">.</span>http_method_not_allowed<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            handler <span class="token operator">=</span> self<span class="token punctuation">.</span>http_method_not_allowed</span>
<span class="line"></span>
<span class="line">        response <span class="token operator">=</span> handler<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> exc<span class="token punctuation">:</span></span>
<span class="line">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>handle_exception<span class="token punctuation">(</span>exc<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    self<span class="token punctuation">.</span>response <span class="token operator">=</span> self<span class="token punctuation">.</span>finalize_response<span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> self<span class="token punctuation">.</span>response</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个dispatch方法的作用：</p>
<ul>
<li>原生django中request传递过来的数据，把他们封装到字典或者元组中，存入APIView的self.args和self.kwargs中</li>
<li>并且对django的request进行二次封装</li>
<li>设置响应头</li>
</ul>
<h4 id="drf封装的request" tabindex="-1"><a class="header-anchor" href="#drf封装的request"><span>Drf封装的request</span></a></h4>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">initialize_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">        Returns the initial request object.</span>
<span class="line">        """</span></span>
<span class="line">    parser_context <span class="token operator">=</span> self<span class="token punctuation">.</span>get_parser_context<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> Request<span class="token punctuation">(</span></span>
<span class="line">        request<span class="token punctuation">,</span></span>
<span class="line">        parsers<span class="token operator">=</span>self<span class="token punctuation">.</span>get_parsers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        authenticators<span class="token operator">=</span>self<span class="token punctuation">.</span>get_authenticators<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        negotiator<span class="token operator">=</span>self<span class="token punctuation">.</span>get_content_negotiator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        parser_context<span class="token operator">=</span>parser_context</span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>authenticators=self.get_authenticators()</strong>  在Drf的request当中新增了用户认证</p>
<p>我们来看一下用户认证具体实现的方法</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_authenticators</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Instantiates and returns the list of authenticators that this view can use.</span>
<span class="line">    """</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span>auth<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> auth <span class="token keyword">in</span> self<span class="token punctuation">.</span>authentication_classes<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<ol>
<li>self.get_authenticators()源码分析，采用列表生成式，循环self.authentication_classes，实例化其中的每一个类，返回列表。</li>
<li>不难发现authentication_classes属性正式我们在认证的时候用到认证类列表，这里会自动寻找该属性进行认证。</li>
<li>倘若我们的视图类没有定义认证方法呢？，当然django rest framework 已经给我们加了默认配置，</li>
<li>如果我们没有定义会自动使用settings中的DEFAULT_AUTHENTICATION_CLASSES作为默认(全局)下面是APIView类中的共有属性</li>
</ol>
</blockquote>
<div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre v-pre class="language-text"><code><span class="line">我们上面分析了APIView在原有的request基础上封装了一些其他功能</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">self.initialize_request(request, *args, **kwargs)</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">我们继续分析往下从diapath()这个方法往下走</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">我们可以看到他是将我们封装后的新的request继续往下传递，然后执行</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在dispatch函数当中还有一个<code v-pre>self.initial(request, *args, **kwargs)</code>方法</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token comment"># 这里的request 是封装后的request，传入def initial(self, request, *args, **kwargs)这个方法</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">initial</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Runs anything that needs to occur prior to calling the method handler.</span>
<span class="line">    """</span></span>
<span class="line">    self<span class="token punctuation">.</span>format_kwarg <span class="token operator">=</span> self<span class="token punctuation">.</span>get_format_suffix<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Perform content negotiation and store the accepted info on the request</span></span>
<span class="line">    neg <span class="token operator">=</span> self<span class="token punctuation">.</span>perform_content_negotiation<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">    request<span class="token punctuation">.</span>accepted_renderer<span class="token punctuation">,</span> request<span class="token punctuation">.</span>accepted_media_type <span class="token operator">=</span> neg</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Determine the API version, if versioning is in use.</span></span>
<span class="line">    version<span class="token punctuation">,</span> scheme <span class="token operator">=</span> self<span class="token punctuation">.</span>determine_version<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">    request<span class="token punctuation">.</span>version<span class="token punctuation">,</span> request<span class="token punctuation">.</span>versioning_scheme <span class="token operator">=</span> version<span class="token punctuation">,</span> scheme</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># Ensure that the incoming request is permitted</span></span>
<span class="line">    <span class="token comment"># 身份认证</span></span>
<span class="line">    self<span class="token punctuation">.</span>perform_authentication<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 检查权限</span></span>
<span class="line">    self<span class="token punctuation">.</span>check_permissions<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 流量限速</span></span>
<span class="line">    self<span class="token punctuation">.</span>check_throttles<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="dispatch中的用户认证" tabindex="-1"><a class="header-anchor" href="#dispatch中的用户认证"><span>dispatch中的用户认证</span></a></h4>
<p><strong>perform_authentication</strong></p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">perform_authentication</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Perform authentication on the incoming request.</span>
<span class="line"></span>
<span class="line">    Note that if you override this and simply 'pass', then authentication</span>
<span class="line">    will instead be performed lazily, the first time either</span>
<span class="line">    `request.user` or `request.auth` is accessed.</span>
<span class="line">    """</span></span>
<span class="line">    request<span class="token punctuation">.</span>user</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>他返回的是新封装request的user属性。那我们就得看下他源码是如何封装这个属性，以及user这个属性表示什么</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token decorator annotation punctuation">@property</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">user</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Returns the user associated with the current request, as authenticated</span>
<span class="line">    by the authentication classes provided to the request.</span>
<span class="line">    </span>
<span class="line">    返回与当前请求关联的经过身份验证的用户，提供给请求的身份验证</span>
<span class="line">    """</span></span>
<span class="line">    <span class="token comment"># 判断如果_user 不在request中的话，执行 self._authenticate()这个方法</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'_user'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">with</span> wrap_attributeerrors<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 执行认证方法</span></span>
<span class="line">            self<span class="token punctuation">.</span>_authenticate<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_user</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre v-pre class="language-text"><code><span class="line">这里面的user是在新的封装的request这个类中找到的</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>我们可以看到他其实还是执行了self._authenticate()。我们还是要看下他的这个authenticate()方法。</p>
<p><strong>self._authenticate</strong></p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">_authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Attempt to authenticate the request using each authentication instance</span>
<span class="line">    in turn.</span>
<span class="line">    """</span></span>
<span class="line">    <span class="token keyword">for</span> authenticator <span class="token keyword">in</span> self<span class="token punctuation">.</span>authenticators<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment"># 执行认证类的authenticate方法</span></span>
<span class="line">            <span class="token comment"># 这里分三种情况</span></span>
<span class="line">            <span class="token comment"># 1.如果authenticate方法抛出异常，self._not_authenticated()执行</span></span>
<span class="line">            <span class="token comment"># 2.有返回值，必须是元组：（request.user,request.auth）</span></span>
<span class="line">            </span>
<span class="line">            </span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># 认证类的实例执行authenticate()这个方法，这个可以重写自己的代码逻辑</span></span>
<span class="line">            user_auth_tuple <span class="token operator">=</span> authenticator<span class="token punctuation">.</span>authenticate<span class="token punctuation">(</span>self<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> exceptions<span class="token punctuation">.</span>APIException<span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_not_authenticated<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">raise</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 3.返回None，表示当前认证不处理，等下一个认证来处理</span></span>
<span class="line">        <span class="token keyword">if</span> user_auth_tuple <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>_authenticator <span class="token operator">=</span> authenticator</span>
<span class="line">            <span class="token comment"># 返回值对应示例中的token_obj.user和token_obj</span></span>
<span class="line">            self<span class="token punctuation">.</span>user<span class="token punctuation">,</span> self<span class="token punctuation">.</span>auth <span class="token operator">=</span> user_auth_tuple</span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line"></span>
<span class="line">    self<span class="token punctuation">.</span>_not_authenticated<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>小结</strong></p>
<div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre v-pre class="language-text"><code><span class="line">1. 这里他将执行每一个认证类的实例的authenticate()方法，也就是说如果要写认证类的话是必须写这个方法的</span>
<span class="line">2. 必须要求返回元祖，然后元祖不为空时就将元祖内的user赋值给self.user，其实也就是侧面赋值给了self._user,</span>
<span class="line">返回到self.perform_authentication(request)这里，其实也就是返回了这个self._user,使得我们认证知道请求是谁，是否登录的作用</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>def authenticate(self, request)</strong></p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">ForcedAuthentication</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    This authentication class is used if the test client or request factory</span>
<span class="line">    forcibly authenticated the request.</span>
<span class="line">    """</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> force_user<span class="token punctuation">,</span> force_token<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>force_user <span class="token operator">=</span> force_user</span>
<span class="line">        self<span class="token punctuation">.</span>force_token <span class="token operator">=</span> force_token</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 一定返回元组</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>force_user<span class="token punctuation">,</span> self<span class="token punctuation">.</span>force_token<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个认证工厂要求必须返回元祖</p>
<p><strong>def _not_authenticated(self)</strong></p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">_not_authenticated</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    Set authenticator, user &amp; authtoken representing an unauthenticated request.</span>
<span class="line"></span>
<span class="line">    Defaults are None, AnonymousUser &amp; None.</span>
<span class="line">    """</span></span>
<span class="line">    self<span class="token punctuation">.</span>_authenticator <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> api_settings<span class="token punctuation">.</span>UNAUTHENTICATED_USER<span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>user <span class="token operator">=</span> api_settings<span class="token punctuation">.</span>UNAUTHENTICATED_USER<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> api_settings<span class="token punctuation">.</span>UNAUTHENTICATED_TOKEN<span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>auth <span class="token operator">=</span> api_settings<span class="token punctuation">.</span>UNAUTHENTICATED_TOKEN<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>小结</strong></p>
<div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre v-pre class="language-text"><code><span class="line">没有身份，相当于匿名用户，默认设置AnonymousUser，如需要单独设置匿名用户返回值，</span>
<span class="line">则编写需要写UNAUTHENTICATED_USER的返回值</span>
<span class="line"></span>
<span class="line">所以我们需要认证的时候，需要在每一个认证类中定义authenticate进行验证，并且需要返回元祖</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="全局配置与局部配置" tabindex="-1"><a class="header-anchor" href="#全局配置与局部配置"><span>全局配置与局部配置</span></a></h4>
<p>首先我们先补充点面向对象的知识</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">APIView</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">	authentication_classes<span class="token operator">=</span>读取配置文件中的列表</span>
<span class="line">	<span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">		self<span class="token punctuation">.</span>authentication classes</span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Userview</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">	authentication_classes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">obj Userview<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">obj<span class="token punctuation">.</span>dispatch<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在创建子类对象时，调用子类对象的方法时，优先会去子类中找，如果没有才会去父类找，如果父类方法中也调用了方法，也会优先去子类找方法，找不到才会在父类调用方法。</p>
<p><strong>和前文的base.py(Django的View视图)中调用了dispatch方法，而其并未定义dispatch方法，让其子类(APIView)去实现（接受参数，封装request对象，添加认证功能等等）</strong></p>
<h5 id="全局配置" tabindex="-1"><a class="header-anchor" href="#全局配置"><span>全局配置</span></a></h5>
<p>在setting.py中加入以下代码</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token comment"># 全局配置Drf</span></span>
<span class="line">REST_FRAMEWORK<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">"DEFAULT_AUTHENTICATION_CLASSES"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"ext.auth.LoginAuthentication"</span><span class="token punctuation">,</span><span class="token punctuation">]</span> <span class="token comment">#你自己认证类的路径</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述自定义的配置文件本质是</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">get_authenticators</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""</span>
<span class="line">        Instantiates and returns the list of authenticators that this view can use.</span>
<span class="line">        """</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">[</span>auth<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> auth <span class="token keyword">in</span> self<span class="token punctuation">.</span>authentication_classes<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Drf会在APIView中实例化authentication_classes里的内容</p>
<h5 id="局部配置" tabindex="-1"><a class="header-anchor" href="#局部配置"><span>局部配置</span></a></h5>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token comment"># 可以设置authentication_classes中列表的值添加验证组件</span></span>
<span class="line">authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    LoginAuthentication<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据前面面向对象的知识，当我们自定义验证类的时候，并使用自定义类的as_view时，优先级是大于Drf所读取的配置文件。</p>
<p>也就是说，局部配置  &gt;  全局配置</p>
<p>举个例子：</p>
<p>验证类:</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authentication <span class="token keyword">import</span> BaseAuthentication</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> AuthenticationFailed</span>
<span class="line"><span class="token comment"># Create your views here.</span></span>
<span class="line"><span class="token comment"># 用户是否登录校验</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">LoginAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>_request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> token<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">"username"</span><span class="token punctuation">,</span> token</span>
<span class="line">        <span class="token keyword">raise</span> AuthenticationFailed<span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">'error_msg'</span><span class="token punctuation">:</span> <span class="token string">"你的账户尚未登录"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>视图类：</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> APIView</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> ext<span class="token punctuation">.</span>auth <span class="token keyword">import</span> LoginAuthentication</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 首页</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Home</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 可以设置authentication_classes中列表的值添加验证组件</span></span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">        LoginAuthentication<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 认证类会把request.user,request.auth返回给一个元组，并且该示例中request.auth是一个token</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"success_msg"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"token为</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>auth<span class="token punctuation">}</span></span><span class="token string">的用户 --登陆成功"</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 订单</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Order</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"success_msg"</span><span class="token punctuation">:</span> <span class="token string">"登陆成功"</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>全局配置：</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token comment"># 全局配置Drf</span></span>
<span class="line">REST_FRAMEWORK<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">"DEFAULT_AUTHENTICATION_CLASSES"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"ext.auth.LoginAuthentication"</span><span class="token punctuation">,</span><span class="token punctuation">]</span> <span class="token comment">#你自己认证类的路径</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403094500255.png" alt="image-20240403094500255"></p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403094710351.png" alt="image-20240403094710351"></p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403094737339.png" alt="image-20240403094737339"></p>
<p>子类配置的authentication_classes会覆盖全局配置，如Order接口所示。</p>
<h4 id="多个认证类" tabindex="-1"><a class="header-anchor" href="#多个认证类"><span>多个认证类</span></a></h4>
<blockquote>
<p>假如说我现在有一个业务需求，写一个校验用户发起的请求是否携带token的接口，各个平台的token携带方式不同，比如：</p>
<p>PC端网页=&gt;url</p>
<p>微信小程序=&gt;request-header</p>
<p>安卓浏览器=&gt;request-body</p>
</blockquote>
<p>在ext下的auth设置多个认证类</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token comment"># 检验url是否有token</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UrlAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> token<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"url"</span><span class="token punctuation">,</span>token</span>
<span class="line"><span class="token comment"># 检验请求头是否有token</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RequestHeadAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"HTTP_TOKEN"</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> token<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"request-head"</span><span class="token punctuation">,</span> token</span>
<span class="line"><span class="token comment"># 检验请求体是否·有token</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RequestBodyAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> token<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"request-body"</span><span class="token punctuation">,</span> token</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>views.py</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">Index</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span>UrlAuthentication<span class="token punctuation">,</span>RequestHeadAuthentication<span class="token punctuation">,</span>RequestBodyAuthentication<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>auth</span>
<span class="line">        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span><span class="token string-interpolation"><span class="token string">f"用户</span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">}</span></span><span class="token string">通过</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>user<span class="token punctuation">}</span></span><span class="token string">,欢迎您来到首页"</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403222028788.png" alt="image-20240403222028788"></p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403222126256.png" alt="image-20240403222126256"></p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403222156070.png" alt="image-20240403222156070"></p>
<p>当时这样做会有个漏洞，假如说用户哪个地方都没携带token</p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403222458353.png" alt="image-20240403222458353"></p>
<p><strong>为了避免这种情况，我们应该在视图中的authenication_classes末尾添加一个直接抛出异常的认证类，给用户返回403状态码，因为用户没有足够权限，必须得登录，生成token</strong></p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">NoLoginAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">raise</span> AuthenticationFailed<span class="token punctuation">(</span><span class="token string">"您没有足够权限，请您登录"</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403224308069.png" alt="image-20240403224308069"></p>
<h4 id="authenticate-header作用" tabindex="-1"><a class="header-anchor" href="#authenticate-header作用"><span>authenticate_header作用</span></a></h4>
<blockquote>
<p>authenticate_header的作用是返回“WWW-Authenticate: xxxxxx”信息和正确的状态码</p>
</blockquote>
<p>假如说认证类不设置authenticate_header，用户访问出错会返回403状态码</p>
<p>实际上，Drf的AuthenticationFailed是这样定义的</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">AuthenticationFailed</span><span class="token punctuation">(</span>APIException<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    status_code <span class="token operator">=</span> status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED</span>
<span class="line">    default_detail <span class="token operator">=</span> _<span class="token punctuation">(</span><span class="token string">'Incorrect authentication credentials.'</span><span class="token punctuation">)</span></span>
<span class="line">    default_code <span class="token operator">=</span> <span class="token string">'authentication_failed'</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是认证不通过，则返回401状态码</p>
<blockquote>
<p><strong>补充:</strong></p>
<p>401 ===&gt; 一般是指认证错误，这是专门为认证设计的</p>
<p>403 ===&gt; 服务器禁止用户访问资源，不仅仅只包含认证问题，比如说爬虫的时候，使用多线程爬取网站，结果爬到一半，直接报403，对方服务器使用自动化脚本把你IP封了，</p>
<p>说到底服务器就是监测用户可疑行为，如发现用户所在位置被屏蔽了（openai）,就会直接封禁，不允许用户访问</p>
<p>可以说403包含了401</p>
<p>AuthenticationFailed使用401状态码更加精准</p>
</blockquote>
<p>就拿上面的Home接口举例</p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403094500255-1712157606757-1.png" alt="image-20240403094500255"></p>
<p>没有设置authenticate_header导致返回状态码出错</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">authenticate_header</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">"API"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>往认证类追加authenticate_header方法后：</p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403232351791.png" alt="image-20240403232351791"></p>
<p>Drf还提供了另一种authenticate_header的方法</p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">def</span> <span class="token function">authenticate_header</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">'Basic realm="%s"'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>www_authenticate_realm</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在监测到响应头有“WWW-Authenticate: xxxxxx”信息时：弹出弹窗校验</p>
<p><img src="https://gitee.com/pan-zhi_jian/cloud-imgs/raw/master/img/image-20240403234146933.png" alt="image-20240403234146933"></p>
<blockquote>
<p>但是实际开发用得很少，因为请求接口，要么成功，要么失败，成功返回数据，失败返回状态码，错误信息，你弹个弹窗出来是什么意思嘛~~</p>
</blockquote>
<h4 id="自定义认证类和其父类-baseauthentication" tabindex="-1"><a class="header-anchor" href="#自定义认证类和其父类-baseauthentication"><span>自定义认证类和其父类(BaseAuthentication)</span></a></h4>
<p><strong>BaseAuthentication</strong></p>
<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre v-pre class="language-python"><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">BaseAuthentication</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""</span>
<span class="line">    All authentication classes should extend BaseAuthentication.</span>
<span class="line">    """</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""</span>
<span class="line">        Authenticate the request and return a two-tuple of (user, token).</span>
<span class="line">        """</span></span>
<span class="line">        <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string">".authenticate() must be overridden."</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate_header</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""</span>
<span class="line">        Return a string to be used as the value of the `WWW-Authenticate`</span>
<span class="line">        header in a `401 Unauthenticated` response, or `None` if the</span>
<span class="line">        authentication scheme should return `403 Permission Denied` responses.</span>
<span class="line">        """</span></span>
<span class="line">        <span class="token keyword">pass</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>父类的authenticate方法直接抛出异常，<strong>子类必须重写该方法</strong>，否则Drf加载自定义认证类时候会直接去父类找，抛出异常，程序报错</p>
</blockquote>
</div></template>


